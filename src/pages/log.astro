---
// 日記コンテンツ画面
import CommonHead from '../components/CommonHead.astro';
import GlobalStyles from '../components/GlobalStyles.astro';
import ScrollbarStyles from '../components/ScrollbarStyles.astro';
import CustomCursor from '../components/CustomCursor.astro';
import NavigationElements from '../components/NavigationElements.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import { getCollection } from 'astro:content';

// Content Collectionsから記事データを取得（サーバーサイドで処理）
const allEntries = await getCollection('202509');
// 日付の新しい順にソート
const sortedEntries = allEntries.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
const diaryEntries = sortedEntries.map((entry, index) => ({
    id: entry.slug,
    date: entry.data.date,
    title: entry.data.title,
    summary: entry.data.summary,
    tags: entry.data.tags
}));
---

<html lang="ja">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="view-transition" content="same-origin" />
    <CommonHead title="aonisum/log" description="日記コンテンツ" />
    <GlobalStyles />
    <ScrollbarStyles />
    <CustomCursor />
</head>
<body>
    <div class="content-root">
        <!-- 中央スラッシュ -->
        <div class="content-slash" id="contentSlash">
            <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 20 L0 70" stroke="#272727" stroke-width="0.8" stroke-linecap="square"/>
            </svg>
        </div>

        <!-- コンテンツタイトル -->
        <div class="content-title" id="contentTitle">log</div>

        <!-- メニュー戻るボタン（リンク遷移でView Transition発火） -->
        <NavigationElements 
            showBackButton={true}
            backButtonUrl="/menu"
            backButtonLabel="メニューに戻る"
            showCopyright={true}
            copyrightText="aonisum©"
            copyrightUrl="/entrance"
        />
        
        <!-- 月アイコン -->
        <ThemeToggle position="content" />
        
        <!-- アイランド: 日記一覧コンテナ -->
        <section class="content-island" id="diaryIsland">
            <header class="island-title" id="diaryIslandTitle">list</header>
            <div class="island-content">
                <ul class="diary-list" id="diaryList"></ul>
                <div class="scrollbar-mask" aria-hidden="true"></div>
            </div>
            <div class="island-pager">
                <button class="pager-btn" id="prevPage" aria-label="前の10件"><span>&lt;</span></button>
                <span class="page-indicator" id="pageIndicator">1/1</span>
                <button class="pager-btn" id="nextPage" aria-label="次の10件"><span>&gt;</span></button>
            </div>
        </section>
    </div>

    <script define:vars={{ diaryEntries }}>
        // カスタムスクロールバー（スクロール時のみ表示）
        // initCustomScrollbars(); // 一時的に無効化

        // メニュー状態保存処理
        document.addEventListener('astro:before-preparation', () => {
            // 現在のコンテンツ名を保存
            localStorage.setItem('currentContent', 'log');
        });
        
        // ===== 日記一覧：ページング（暫定の最大表示件数は10件。後から変更可能）
        const DIARY_PAGE_SIZE_DEFAULT = 10;
        let diaryPageSize = DIARY_PAGE_SIZE_DEFAULT;
        let diaryPage = 1;
        
        // デバッグ: 記事データの確認
        console.log('=== log.astro デバッグ ===');
        console.log('JavaScript実行確認');
        console.log('diaryEntries length:', diaryEntries.length);
        console.log('diaryEntries:', diaryEntries);

        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        function renderDiaryList() {
            console.log('renderDiaryList実行');
            const listEl = document.getElementById('diaryList');
            const indicator = document.getElementById('pageIndicator');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            if (!listEl || !indicator || !prevBtn || !nextBtn) {
                console.log('要素が見つからない:', { listEl, indicator, prevBtn, nextBtn });
                return;
            }
            
            const totalPages = Math.max(1, Math.ceil(diaryEntries.length / diaryPageSize));
            diaryPage = Math.min(Math.max(1, diaryPage), totalPages);
            const start = (diaryPage - 1) * diaryPageSize;
            const end = start + diaryPageSize;
            const items = diaryEntries.slice(start, end);
            
            // 1. 古い要素のopacityを0.5sかけて0にする
            const currentHeight = listEl.offsetHeight;
            listEl.style.minHeight = currentHeight + 'px';
            listEl.style.opacity = '0';
            
            // 2. 0.5s後に古い要素を削除
            setTimeout(() => {
                listEl.innerHTML = '';
                
                // 3. 新しい要素を追加
                items.forEach((entry, index) => {
                // 年月要素を個別作成
                const dateEl = document.createElement('div');
                dateEl.className = 'diary-date';
                dateEl.textContent = formatDate(entry.date);
                
                // 年月要素に直接スタイルを適用
                dateEl.style.fontSize = '0.8rem';
                dateEl.style.color = '#999';
                dateEl.style.marginBottom = '0.5rem';
                // dateEl.style.cursor = 'url(\'/book-cursor.png\'), pointer';
                
                // タイトル要素を個別作成
                const titleEl = document.createElement('div');
                titleEl.className = 'diary-title';
                // titleEl.style.cursor = 'url(\'/book-cursor.png\'), pointer';
                
                const linkEl = document.createElement('a');
                linkEl.href = `/log_detail/${entry.id}`;
                linkEl.className = 'diary-link';
                linkEl.textContent = entry.title;
                // linkEl.style.cursor = 'url(\'/book-cursor.png\'), pointer';
                
                // デバッグ: リンククリック時の情報
                linkEl.addEventListener('click', (e) => {
                    console.log('=== リンククリック ===');
                    console.log('クリックした記事ID:', entry.id);
                    console.log('クリックした記事タイトル:', entry.title);
                    console.log('遷移先URL:', linkEl.href);
                    console.log('実際のhref属性:', linkEl.getAttribute('href'));
                    console.log('新しいパス形式: /log_detail/' + entry.id);
                });
                
                // リンク要素に直接スタイルを適用
                linkEl.style.fontSize = '1rem';
                // linkEl.style.fontFamily = 'var(--font-secondary)';
                linkEl.style.fontWeight = '300';
                linkEl.style.lineHeight = '1';                
                titleEl.appendChild(linkEl);
                
                // リストアイテムを作成
                const liEl = document.createElement('li');
                liEl.className = 'diary-item';
                liEl.style.padding = '0.01rem 0';
                liEl.appendChild(dateEl);
                liEl.appendChild(titleEl);
                
                listEl.appendChild(liEl);
                
                // セパレータを追加（最後のアイテム以外）
                if (index < items.length - 1) {
                    const separatorEl = document.createElement('li');
                    separatorEl.className = 'diary-separator';
                    separatorEl.innerHTML = `
                        <svg width="100%" height="10" viewBox="0 0 600 1" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <line x1="0" y1="0.2" x2="500" y2="0.2" stroke="#ddd" stroke-width="0.2"/>
                        </svg>
                    `;
                    listEl.appendChild(separatorEl);
                }
                });
                
                indicator.textContent = `${diaryPage}/${totalPages}`;
                
                // ページネーションボタンの有効/無効状態を制御
                prevBtn.disabled = diaryPage <= 1;
                nextBtn.disabled = diaryPage >= totalPages;
                
                // 4. 新しい要素のopacityを1sかけて1にする
                setTimeout(() => {
                    listEl.classList.add('fade-in');
                    listEl.style.minHeight = '';
                    listEl.style.opacity = '1';
                }, 10);
            }, 750); // 0.5s後に古い要素削除と新しい要素追加
        }

        function initDiaryPager(){
            const prev = document.getElementById('prevPage');
            const next = document.getElementById('nextPage');
            if (prev) {
                // 既存のイベントリスナーを削除してから追加（重複防止）
                prev.removeEventListener('click', handlePrevPage);
                prev.addEventListener('click', handlePrevPage);
            }
            if (next) {
                // 既存のイベントリスナーを削除してから追加（重複防止）
                next.removeEventListener('click', handleNextPage);
                next.addEventListener('click', handleNextPage);
            }
        }

        function handlePrevPage() {
            if (diaryPage > 1) {
                diaryPage -= 1;
                renderDiaryList();
            }
        }

        function handleNextPage() {
            const totalPages = Math.max(1, Math.ceil(diaryEntries.length / diaryPageSize));
            if (diaryPage < totalPages) {
                diaryPage += 1;
                renderDiaryList();
            }
        }


        function initializePage() {
            console.log('ページ初期化開始');
            renderDiaryList();
            initDiaryPager();
        }

        // DOM読み込み完了後に初期描画を実行
        console.log('DOM初期化開始');
        if (document.readyState === 'loading') {
            console.log('DOM読み込み中、イベントリスナー追加');
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            console.log('DOM読み込み完了、即座に実行');
            initializePage();
        }
        
        // AstroのView Transitions対応
        document.addEventListener('astro:after-swap', () => {
            setTimeout(() => {
                initializePage();
            }, 100);
        });
        </script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: var(--font-primary);
            background: #fff;
            color: #222;
        }
        body {
            transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        .content-root {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .content-slash {
            position: absolute;
            left: 50vw;
            top: 50vh;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        .content-title {
            position: absolute;
            left: 30vw;
            top: 50vh;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: 300;
            letter-spacing: 0.1em;
            color: #222;
            z-index: 5;
        }

        /* arrow-btn 仕様（menu.astroに準拠） */
        .arrow-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #444;
            /* opacity: 0.1; */
            /* cursor: url('/book-cursor.png'), pointer; */
            margin: 0.5rem 0;
            transition: color 0.2s;
        }
        /* .arrow-btn:hover {
            color: #888;
        } */

        .back-btn {
            background: none;
            border: none;
            /* cursor: url('/book-cursor.png'), pointer; */
            transition: color 0.2s;
        }
        .back-btn:hover svg path {
            stroke: #888;
        }
        .content-name {
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: 0.1em;
            /* cursor: url('/book-cursor.png'), pointer; */
        }
        .content-name:hover {
            color: #888;
        }

        /* ダークモード用 */
        body.dark {
            background: #1F222D;
            color: #fff;
        }

        body.dark .arrow-btn svg path {
            stroke: #eee;
        }
        body.dark .arrow-btn:hover svg path {
            stroke: #fff;
        }


        /* ===== アイランド（コンテンツコンテナ） ===== */
        .content-island {
            position: absolute;
            left: 55vw;
            top: 15vh;
            width: 35vw;   /* aboutに合わせる */
            height: 65vh;
            box-sizing: border-box;
            border: none;
            padding: 0;
            overflow: hidden;
            z-index: 6;
            background: transparent;
        }
        .island-title {
            position: absolute;
            left: 5%;
            top: 5%;
            font-size: 1.2rem; /* content-nameと同サイズ */
            letter-spacing: 0.1em;
        }
        .island-content {
            position: absolute;
            left: 5%;
            top: 15%;
            width: 90%;
            height: 70%;
            overflow: auto;
        }
        /* スクロールバー関連は共通スタイルへ移行（ScrollbarStyles） */
        .diary-list {
            margin: 0;
            padding: 0;
            list-style: none;
            /* 高さの急激な変化を防ぐ */
            transition: min-height 0.1s ease-out, opacity 1s ease-in-out;
        }
        
        /* 新しい要素のフェードイン用（1秒） */
        .diary-list.fade-in {
            transition: opacity 1s ease-in-out;
        }
        
        .diary-item {
            padding: 1.5rem 0;
            border-bottom: 2px solid #ddd;
        }
        
        .diary-item:last-child {
            border-bottom: none;
        }

        .diary-separator {
            list-style: none;
            padding: 0.5rem 0;
            margin: 0;
        }

        .diary-separator svg {
            display: block;
            width: 100%;
        }
        
        /* 動的要素はJavaScriptで直接スタイル適用のため、CSSルールは不要 */
        .island-pager {
            position: absolute;
            right: 5%;
            bottom: 5%;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .pager-btn {
            background: none;
            border: none;
            /* cursor: url('/book-cursor.png'), pointer; */
            font-size: 1rem;
            color: #616161;
            /* opacity: 0.1; */
            /* cursor: url('/book-cursor.png'), pointer; */
            transition: color 0.2s;
        }
        .pager-btn:hover:not(:disabled) { color: #888; }
        .pager-btn:disabled {
            color: #ccc;
            /* cursor: default; */
        }
        .page-indicator { font-size: 0.9rem; }
        body.dark .content-island { border: none; }
        body.dark .island-title { color: #eee; }
        body.dark .diary-list { color: #eee; }
        body.dark .pager-btn { color: #eee; }
        body.dark .pager-btn:hover:not(:disabled) { color: #fff; }
        body.dark .pager-btn:disabled {
            color: #555;
        }
        
        body.dark .diary-item {
            border-bottom-color: #444;
        }
        
        /* 動的要素のダークテーマスタイルもJavaScriptで制御 */

        body.dark .diary-separator svg line {
            stroke: #444;
        }

        body.dark .content-slash svg path {
            stroke: #fff;
        }

        body.dark .content-title {
            color: #eee;
        }
    </style>
</body>
</html> 
            <!-- // ===== テストデータ（再利用可能なためコメントアウトして保持） ===== -->
            <!-- /*
            const diaryEntries = [
                { id: 1, date: "2024-01-15", title: "冬の朝の静寂", summary: "窓の外で雪が静かに降り積もる。世界が白一色に染まる瞬間の美しさについて。", tags: ["日常", "季節", "美しさ"] },
                { id: 2, date: "2024-01-20", title: "古い本との出会い", summary: "古書店で見つけた一冊の本。ページをめくるたびに漂う古い紙の香りと、そこに込められた時間について。", tags: ["読書", "時間", "香り"] },
                { id: 3, date: "2024-01-25", title: "雨の日の散歩", summary: "傘を差して歩く街並み。雨に濡れたアスファルトの匂いと、足音が響く静けさについて。", tags: ["散歩", "雨", "街並み"] },
                { id: 4, date: "2024-02-01", title: "春の兆し", summary: "まだ寒い日々の中、ふと見つけた小さな春の芽吹き。季節の移ろいを感じる瞬間。", tags: ["季節", "春", "自然"] },
                { id: 5, date: "2024-02-05", title: "夜の珈琲", summary: "深夜の静寂の中で淹れる一杯の珈琲。豆を挽く音、お湯を注ぐ音、そして香りについて。", tags: ["珈琲", "夜", "香り"] },
                { id: 6, date: "2024-02-10", title: "古い写真", summary: "アルバムを開いて見つけた古い写真。そこに写る人々の表情と、過ぎ去った時間について。", tags: ["写真", "記憶", "時間"] },
                { id: 7, date: "2024-02-15", title: "夕暮れの空", summary: "一日の終わりを告げる夕暮れの空。刻一刻と変化する色合いと、そこに込められた情感について。", tags: ["夕暮れ", "空", "美しさ"] },
                { id: 8, date: "2024-02-20", title: "街角の音楽", summary: "通りすがりに聞こえた街角の音楽。誰かの心の内を表現する音色について。", tags: ["音楽", "街", "表現"] },
                { id: 9, date: "2024-02-25", title: "朝の光", summary: "カーテンの隙間から差し込む朝の光。新しい一日の始まりを告げる清々しさについて。", tags: ["朝", "光", "始まり"] },
                { id: 10, date: "2024-03-01", title: "古い建物", summary: "街中に残る古い建物。そこに刻まれた歴史と、現代との調和について。", tags: ["建物", "歴史", "街並み"] },
                { id: 11, date: "2024-03-05", title: "花の香り", summary: "春の訪れとともに咲く花々。それぞれが放つ独特の香りと、季節の移ろいについて。", tags: ["花", "香り", "春"] },
                { id: 12, date: "2024-03-10", title: "夜の読書", summary: "静寂に包まれた夜の読書時間。本の世界に没頭する至福の瞬間について。", tags: ["読書", "夜", "静寂"] }
            ];
            */ -->